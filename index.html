<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Vergel | Frescura Natural</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --primary: #FF8C00; 
            --secondary: #4CAF50; 
            --dark: #333;
            --light: #f4f4f4;
            --white: #fff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light);
            color: var(--dark);
        }

        /* Cabecera */
        header {
            background-color: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo { display: flex; align-items: center; text-decoration: none; }

        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; transition: color 0.3s; }
        .nav-links a:hover { color: var(--primary); }

        .cart-btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            position: relative;
        }
        .cart-count {
            background-color: red; color: white; border-radius: 50%;
            padding: 2px 6px; font-size: 0.8rem; position: absolute; top: -5px; right: -5px;
        }

        /* Secciones */
        section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        h2 { text-align: center; color: var(--secondary); margin-bottom: 30px; text-transform: uppercase; }

        /* Hero */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center;
            color: white; text-align: center; padding: 100px 20px;
            border-radius: 0 0 20px 20px;
        }
        .hero h1 { font-size: 3rem; margin-bottom: 10px; }

        /* Grilla Productos */
        .product-grid, .content-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;
        }

        .card {
            background: var(--white); border-radius: 10px; overflow: hidden;
            box-shadow: var(--shadow); transition: transform 0.3s;
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); }

        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .price-tag { color: var(--secondary); font-weight: bold; font-size: 1.2rem; }
        .promo-badge { background-color: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-bottom: 5px; }

        .btn-add {
            background-color: var(--secondary); color: white; border: none;
            padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 1rem;
        }
        .btn-add:hover { background-color: #388E3C; }

        /* Video Container */
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

        /* Contacto */
        .forms-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .btn-form { display: inline-block; padding: 15px 30px; background-color: var(--primary); color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }

        /* Footer */
        footer { background-color: var(--dark); color: white; text-align: center; padding: 20px; margin-top: 40px; }

        /* Modal Carrito */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }

        /* --- NUEVO: ESTILOS RASTREO --- */
        <section id="tracking-section">
        <div class="status-card">
            <h2>üì¶ Rastrea tu Pedido</h2>
            <p>Ingresa el c√≥digo de tu pedido para ver el estado.</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <input type="text" id="tracking-id-input" placeholder="Ej: a1b2c3d4" style="padding: 10px; width: 60%;">
                <button class="btn-add" onclick="buscarPedidoManual()" style="width: auto;">Buscar üîç</button>
            </div>

            <div id="tracking-result"></div>
            
            <br>
            <a href="index.html" class="btn-add" style="text-decoration: none; width: auto; display: inline-block; background-color: #666;">‚¨Ö Volver al Inicio</a>
        </div>
    </section>
</head>
<body>

    <header>
        <nav>
            <a href="index.html" class="logo">
                <img src="logo.JPG" alt="Logo El Vergel" style="height: 50px;">
            </a>
           <div class="nav-links">
    <a href="index.html">Inicio</a>
    
    <a href="#" onclick="abrirRastreo()">üì¶ Rastrear</a> 
    
    <a href="#ofertas">Ofertas</a>
    <a href="#productos">Pedidos</a>
    <a href="#contacto">Contacto</a>
</div>
            <div class="cart-btn" onclick="toggleCart()">
                üõí <span id="cart-count" class="cart-count">0</span>
            </div>
        </nav>
    </header>

    <section id="tracking-section">
        <div class="status-card">
            <h2>üì¶ Estado de tu Pedido</h2>
            <div id="tracking-result">
                <div class="loader">Buscando tu pedido...</div>
            </div>
            <br>
            <a href="index.html" class="btn-add" style="text-decoration: none; width: auto; display: inline-block;">‚¨Ö Volver a la Tienda</a>
        </div>
    </section>

    <div id="main-content" class="main-content">
        <div id="inicio" class="hero">
            <h1>Bienvenido a El Vergel</h1>
            <p>Frutas y verduras frescas seleccionadas para ti.</p>
        </div>

        <section id="ofertas">
            <h2>üî• Ofertas Imperdibles</h2>
            <div id="ofertas-container" class="product-grid">
                <div class="loader">Cargando ofertas...</div>
            </div>
        </section>

        <section id="productos">
            <h2>ü•¨ Haz tu Pedido</h2>
            <div id="productos-container" class="product-grid">
                <div class="loader">Cargando productos frescos...</div>
            </div>
        </section>

        <section id="tips">
            <h2>üí° Tips y Recetas</h2>
            <div id="tips-container" class="content-grid">
                <div class="loader">Cargando contenido...</div>
            </div>
        </section>

        <section id="contacto">
            <h2>üìû Satisfacci√≥n y Contacto</h2>
            <p style="text-align: center; margin-bottom: 20px;">Tu opini√≥n nos ayuda a crecer.</p>
            
            <div class="forms-container">
                <a href="#" class="btn-form" target="_blank">üìã Buz√≥n de Sugerencias</a>
                <a href="#" class="btn-form" target="_blank">üì¢ Libro de Reclamos</a>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <h3>¬øQui√©nes Somos?</h3>
                <p>Somos una verduler√≠a familiar comprometida con llevar lo mejor del campo a tu mesa.</p>
            </div>
        </section>
    </div>

    <footer>
        <p>&copy; 2024 El Vergel. Todos los derechos reservados.</p>
    </footer>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary);">üõí Tu Canasta</h3>
            <div id="cart-items">
                <p>Tu carrito est√° vac√≠o.</p>
            </div>
            <div style="text-align: right; margin: 20px 0; font-weight: bold; font-size: 1.2rem;">
                Total: $<span id="cart-total">0</span>
            </div>
            
            <hr>
            <h4>Finalizar Pedido</h4>
            <div class="form-group">
                <label>Nombre y Apellido:</label>
                <input type="text" id="cliente-nombre" placeholder="Ej: Juan Perez">
            </div>
            <div class="form-group">
                <label>WhatsApp:</label>
                <input type="tel" id="cliente-whatsapp" placeholder="Ej: 11 1234 5678">
            </div>

            <button class="btn-add" onclick="enviarPedido()">‚úÖ Confirmar Pedido</button>
            <button onclick="toggleCart()" style="margin-top: 10px; background: transparent; border: none; color: #666; cursor: pointer; width: 100%;">Seguir comprando</button>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è PEGA AQU√ç TU NUEVA URL DE GOOGLE APPS SCRIPT ‚ö†Ô∏è
        const API_URL = 'https://script.google.com/macros/s/AKfycbzDOwPK2N6EcNrMmwNx_3hFle8stwjmxUp0RbKgw6-bl9WJAyY5_iXslqOA882447A/exec';
        
        let carrito = [];
        let productosGlobal = [];

        document.addEventListener('DOMContentLoaded', () => {
            // VERIFICAR SI HAY ID DE PEDIDO EN LA URL
            const urlParams = new URLSearchParams(window.location.search);
            const idPedido = urlParams.get('id');

            if (idPedido) {
                // MODO RASTREO: Ocultar tienda y mostrar rastreo
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('tracking-section').style.display = 'block';
                buscarEstadoPedido(idPedido);
            } else {
                // MODO TIENDA: Cargar productos normales
                cargarProductos();
                cargarContenido();
            }
        });

        // --- FUNCI√ìN DE RASTREO ---
        function buscarEstadoPedido(id) {
            fetch(API_URL + '?action=getPedido&id=' + id)
                .then(response => response.json())
                .then(data => {
                    const resultDiv = document.getElementById('tracking-result');
                    if (data.encontrado) {
                        let ticketHTML = '';
                        if (data.ticket) {
                            ticketHTML = `<div><p>Tu Ticket:</p><img src="${data.ticket}" class="ticket-img" alt="Ticket de compra"></div>`;
                        }
                        
                        // Clase de color seg√∫n estado
                        let estadoClass = 'status-Recibido';
                        if(data.estado.includes('Preparaci√≥n')) estadoClass = 'status-En';
                        if(data.estado.includes('Listo')) estadoClass = 'status-Listo';
                        if(data.estado.includes('Entregado')) estadoClass = 'status-Entregado';

                        resultDiv.innerHTML = `
                            <p style="color:#666;">ID Pedido: <strong>${id}</strong></p>
                            <div class="status-badge ${estadoClass}">${data.estado}</div>
                            <p style="font-size: 1.2rem;">Total a Pagar: <strong>$${data.total}</strong></p>
                            ${ticketHTML}
                        `;
                    } else {
                        resultDiv.innerHTML = `<p style="color:red;">‚ùå No encontramos un pedido con ese c√≥digo.</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('tracking-result').innerHTML = `<p>Error al conectar con el servidor.</p>`;
                });
        }

        // --- FUNCIONES DE LA TIENDA ---
        function cargarProductos() {
            fetch(API_URL + '?action=getProductos')
                .then(response => response.json())
                .then(data => {
                    productosGlobal = data;
                    renderizarProductos(data);
                });
        }

        function cargarContenido() {
            fetch(API_URL + '?action=getContenido')
                .then(response => response.json())
                .then(data => renderizarContenido(data));
        }

        function renderizarProductos(productos) {
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            productos.forEach(p => {
                if(p.Disponible === false || p.Disponible === "FALSE") return;
                
                let precioDisplay = `$${p.Precio_Regular}`;
                if(p.Precio_Oferta && p.Cantidad_Oferta) {
                    precioDisplay = `<div>$${p.Precio_Regular}</div>
                                     <div style="font-size:0.8em; color:var(--primary)">Oferta x ${p.Cantidad_Oferta}${p.Tipo_Venta}: $${p.Precio_Oferta}</div>`;
                }

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <img src="${p.Imagen_URL || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300?text=Sin+Foto'">
                    <div class="card-body">
                        <div>
                            <div class="card-title">${p.Nombre}</div>
                            <div class="card-desc">${p.Descripcion || ''}</div>
                            <div class="promo-badge">${p.Tipo_Venta}</div>
                        </div>
                        <div>
                            <div class="price-tag">${precioDisplay}</div>
                            <button class="btn-add" onclick="agregarAlCarrito('${p.ID_Producto}')">Agregar +</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderizarContenido(items) {
            const ofertasContainer = document.getElementById('ofertas-container');
            const tipsContainer = document.getElementById('tips-container');
            ofertasContainer.innerHTML = '';
            tipsContainer.innerHTML = '';

            items.forEach(item => {
                const elemento = document.createElement('div');
                elemento.className = 'card';
                let mediaHTML = '';
                if(item.Video_URL && item.Video_URL.includes('youtube')) {
                    const videoId = item.Video_URL.split('v=')[1]?.split('&')[0];
                    mediaHTML = `<div class="video-container"><iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe></div>`;
                } else if (item.Imagen_URL) {
                    mediaHTML = `<img src="${item.Imagen_URL}" style="height:200px; object-fit:cover;">`;
                }
                elemento.innerHTML = `${mediaHTML}<div class="card-body"><div class="card-title">${item.Titulo}</div><p>${item.Descripcion}</p></div>`;
                if(item.Tipo === 'Oferta') ofertasContainer.appendChild(elemento);
                else tipsContainer.appendChild(elemento);
            });
            if(ofertasContainer.innerHTML === '') ofertasContainer.innerHTML = '<p>No hay ofertas especiales hoy.</p>';
        }

        // --- CARRITO Y PEDIDOS ---
        function agregarAlCarrito(id) {
            const producto = productosGlobal.find(p => p.ID_Producto == id);
            const existente = carrito.find(item => item.id == id);
            if(existente) existente.cantidad++;
            else carrito.push({ id: id, nombre: producto.Nombre, precio: producto.Precio_Regular, cantidad: 1, unidad: producto.Tipo_Venta });
            actualizarCarritoUI();
            alert(`¬°${producto.Nombre} agregado!`);
        }

        function actualizarCarritoUI() {
            document.getElementById('cart-count').innerText = carrito.reduce((acc, item) => acc + item.cantidad, 0);
            const itemsContainer = document.getElementById('cart-items');
            itemsContainer.innerHTML = '';
            let total = 0;
            carrito.forEach((item, index) => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                itemsContainer.innerHTML += `
                    <div class="cart-item">
                        <div><strong>${item.nombre}</strong> (${item.unidad})<br>$${item.precio} x ${item.cantidad}</div>
                        <div>$${subtotal} <button onclick="eliminarDelCarrito(${index})" style="background:red; color:white; border:none; border-radius:50%;">x</button></div>
                    </div>`;
            });
            document.getElementById('cart-total').innerText = total;
            if(carrito.length === 0) itemsContainer.innerHTML = '<p>Tu carrito est√° vac√≠o.</p>';
        }

        function eliminarDelCarrito(index) { carrito.splice(index, 1); actualizarCarritoUI(); }
        function toggleCart() { const modal = document.getElementById('cart-modal'); modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex'; }

        function enviarPedido() {
            const nombre = document.getElementById('cliente-nombre').value;
            const whatsapp = document.getElementById('cliente-whatsapp').value;
            if(carrito.length === 0) return alert('El carrito est√° vac√≠o');
            if(!nombre || !whatsapp) return alert('Completa nombre y WhatsApp');

            const btn = document.querySelector('.btn-add');
            btn.innerText = 'Enviando...'; btn.disabled = true;

            const pedidoData = {
                nombre: nombre, whatsapp: whatsapp, total: document.getElementById('cart-total').innerText,
                carrito: carrito.map(item => ({ nombre: item.nombre, cantidad: item.cantidad + ' ' + item.unidad, subtotal: item.precio * item.cantidad }))
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(pedidoData),
                headers: { "Content-Type": "text/plain" }
            })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'success') {
                    // AQU√ç GENERAMOS EL LINK DE SEGUIMIENTO REAL PARA EL USUARIO
                    // Quitamos el '#' y el '?' para tener una direcci√≥n limpia
                    const baseUrl = window.location.href.split('#')[0].split('?')[0];
                    const linkSeguimiento = baseUrl + '?id=' + data.idPedido;
                    
                    alert('¬°Pedido Recibido! üçä\n\nGuarda este link para ver el estado:\n' + linkSeguimiento);
                    
                    // Opcional: Redirigir al usuario al rastreo directamente
                    // window.location.href = linkSeguimiento;

                    carrito = []; actualizarCarritoUI(); toggleCart();
                } else { alert('Hubo un error al enviar.'); }
            })
            .catch(error => { console.error(error); alert('Pedido enviado (sin confirmaci√≥n inmediata).'); carrito = []; actualizarCarritoUI(); toggleCart(); })
            .finally(() => { btn.innerText = '‚úÖ Confirmar Pedido'; btn.disabled = false; });
        }
            // --- FUNCI√ìN 1: Para abrir la secci√≥n de b√∫squeda ---
    function abrirRastreo() {
        // Ocultamos la tienda y mostramos el buscador
        document.getElementById('main-content').style.display = 'none';
        document.getElementById('tracking-section').style.display = 'block';
        
        // Limpiamos el resultado anterior por si acaso
        document.getElementById('tracking-result').innerHTML = '';
        document.getElementById('tracking-id-input').value = '';
    }

    // --- FUNCI√ìN 2: Para ejecutar la b√∫squeda manual ---
    function buscarPedidoManual() {
        const inputId = document.getElementById('tracking-id-input').value.trim();
        
        if (inputId === "") {
            alert("Por favor, escribe el c√≥digo de tu pedido.");
            return;
        }

        // Mostramos que estamos pensando...
        document.getElementById('tracking-result').innerHTML = '<div class="loader">Buscando en el sistema... üîç</div>';

        // Llamamos a la funci√≥n que conecta con Google (reutilizamos la que ya ten√≠as)
        buscarEstadoPedido(inputId);
    }

    // --- FUNCI√ìN 3: Volver al inicio (Opcional pero recomendada) ---
    function volverAlInicio() {
        document.getElementById('tracking-section').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
    }
    </script>
</body>
</html>




