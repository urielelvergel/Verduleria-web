<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Vergel | Frescura Natural</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --primary: #FF8C00; 
            --secondary: #4CAF50; 
            --dark: #333;
            --light: #f4f4f4;
            --white: #fff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: var(--light); color: var(--dark); }

        /* Cabecera */
        header { background-color: var(--white); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 1000; }
        nav { max-width: 1200px; margin: 0 auto; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; text-decoration: none; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { text-decoration: none; color: var(--dark); font-weight: 500; }
        .nav-links a:hover { color: var(--primary); }

        .cart-btn { background-color: var(--primary); color: white; padding: 8px 15px; border-radius: 20px; cursor: pointer; position: relative; }
        .cart-count { background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.8rem; position: absolute; top: -5px; right: -5px; }

        /* Secciones */
        section { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        h2 { text-align: center; color: var(--secondary); margin-bottom: 30px; text-transform: uppercase; }

        /* Hero */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover; background-position: center; color: white; text-align: center; padding: 100px 20px;
        }
        .hero h1 { font-size: 3rem; margin: 0; }

        /* Grillas */
        .product-grid, .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }

        /* Tarjetas */
        .card { background: var(--white); border-radius: 10px; overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .price-tag { color: var(--secondary); font-weight: bold; font-size: 1.2rem; }
        .promo-badge { background-color: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-bottom: 5px; }

        /* Controles de Cantidad y Botones */
        .cantidad-control { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; border-radius: 5px; padding: 5px; margin-bottom: 10px; }
        .cantidad-control input { width: 50px; text-align: center; border: none; background: transparent; font-weight: bold; font-size: 1.1rem; }
        .cantidad-control button { background: #ddd; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; background: var(--secondary); color: white; border: none; border-radius: 15px; cursor: pointer; }
        .btn-add { background-color: var(--secondary); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-add:hover { background-color: #388E3C; }

        /* Estilos Rastreo */
        #tracking-section { display: none; text-align: center; padding: 50px 20px; }
        .status-card { background: white; padding: 30px; border-radius: 15px; box-shadow: var(--shadow); max-width: 600px; margin: 0 auto; }
        .status-badge { font-size: 1.5rem; font-weight: bold; padding: 10px 20px; border-radius: 30px; display: inline-block; margin: 20px 0; background: var(--light); }
        .status-Recibido { background: #E3F2FD; color: #1976D2; }
        .status-En { background: #FFF3E0; color: #F57C00; }
        .status-Listo { background: #E8F5E9; color: #388E3C; }
        .status-Entregado { background: #4CAF50; color: white; }
        .ticket-img { max-width: 100%; border-radius: 10px; margin-top: 20px; border: 2px dashed #ccc; }

        /* Modal Carrito */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }

        .loader { text-align: center; padding: 20px; font-style: italic; color: #666; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        footer { background-color: var(--dark); color: white; text-align: center; padding: 20px; margin-top: 40px; }
    </style>
</head>
<body>

    <header>
        <nav>
            <a href="index.html" class="logo">
                <img src="logo.JPG" alt="Logo" style="height: 50px;">
            </a>
            <div class="nav-links">
                <a href="index.html">Inicio</a>
                <a href="#" onclick="abrirRastreo()">üì¶ Rastrear</a>
                <a href="#productos">Pedidos</a>
                <a href="#contacto">Contacto</a>
            </div>
            <div class="cart-btn" onclick="toggleCart()">
                üõí <span id="cart-count" class="cart-count">0</span>
            </div>
        </nav>
    </header>

    <section id="tracking-section">
        <div class="status-card">
            <h2>üì¶ Rastrea tu Pedido</h2>
            <p>Ingresa el c√≥digo que recibiste al comprar (ej: 31012026-1234).</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <input type="text" id="tracking-id-input" placeholder="C√≥digo de pedido" style="padding: 10px; width: 60%; font-size: 1rem;">
                <button class="btn-add" onclick="buscarPedidoManual()" style="width: auto;">Buscar üîç</button>
            </div>
            <div id="tracking-result"></div>
            <br>
            <a href="#" onclick="volverAlInicio()" class="btn-add" style="background:#666; width:auto; display:inline-block; text-decoration:none;">‚¨Ö Volver a la Tienda</a>
        </div>
    </section>

    <div id="main-content">
        <div class="hero">
            <h1>Bienvenido a El Vergel</h1>
            <p>Frutas y verduras frescas a tu mesa.</p>
        </div>

        <section id="ofertas">
            <h2>üî• Ofertas y Contenido</h2>
            <div id="ofertas-container" class="content-grid">
                <div class="loader">Cargando contenido...</div>
            </div>
        </section>

        <section id="productos">
            <h2>ü•¨ Haz tu Pedido</h2>
            <div id="productos-container" class="product-grid">
                <div class="loader">Cargando productos frescos...</div>
            </div>
        </section>

        <section id="contacto">
            <h2>üìû Contacto</h2>
            <div style="text-align: center;">
                <p>¬øDudas? Escr√≠benos.</p>
                <div class="forms-container" style="display:flex; justify-content:center; gap:20px;">
                    <a href="#" class="btn-add" style="width:auto; text-decoration:none;">üìã Sugerencias</a>
                </div>
            </div>
        </section>
    </div>

    <footer><p>&copy; 2026 El Vergel</p></footer>

    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary);">üõí Tu Canasta</h3>
            <div id="cart-items"><p>Tu carrito est√° vac√≠o.</p></div>
            <div style="text-align: right; margin: 20px 0; font-weight: bold; font-size: 1.2rem;">
                Total: $<span id="cart-total">0</span>
            </div>
            <hr>
            <h4>Datos de Env√≠o</h4>
            <div class="form-group"><label>Nombre:</label><input type="text" id="cliente-nombre"></div>
            <div class="form-group"><label>WhatsApp:</label><input type="tel" id="cliente-whatsapp"></div>
            <button class="btn-add" onclick="enviarPedido()">‚úÖ Confirmar Pedido</button>
            <button onclick="toggleCart()" style="margin-top:10px; width:100%; border:none; background:none; cursor:pointer; color:#666;">Seguir comprando</button>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è PEGA AQU√ç TU URL DE IMPLEMENTACI√ìN DE GOOGLE APPS SCRIPT ‚ö†Ô∏è
        const API_URL = 'https://script.google.com/macros/s/AKfycbwvN6eo5emMWv-nqNsfdg5WZ6ApqLfu3Nizr4arWCfdfn5CW7n-PV6HclgFpmhWHg/exec'; 
        
        let carrito = [];
        let productosGlobal = [];

        document.addEventListener('DOMContentLoaded', () => {
            cargarProductos();
            cargarContenido();
        });

        // --- 1. CARGA DE PRODUCTOS (FILTRO DISPONIBLE Y BOTONES KG/UN) ---
        function cargarProductos() {
            fetch(API_URL + '?action=getProductos')
                .then(response => response.json())
                .then(data => {
                    productosGlobal = data;
                    renderizarProductos(data);
                });
        }

        function renderizarProductos(productos) {
            const container = document.getElementById('productos-container');
            container.innerHTML = '';
            
            productos.forEach(p => {
                // FILTRO DE VISIBILIDAD: Si dice FALSE, NO, o vac√≠o, no se muestra
                if(p.Disponible === false || p.Disponible === "FALSE" || p.Disponible === "NO") return;
                
                let controlesHTML = '';
                const unidadTexto = p.Unidad === 'kg' ? 'kg' : 'un';

                if (p.Unidad === 'kg') {
                    // BOTONES PARA PESO (con opciones r√°pidas)
                    controlesHTML = `
                        <div style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
                            <button class="btn-sm" onclick="ajustarCantidad('${p.ID_Producto}', 0.5)">¬Ω kg</button>
                            <button class="btn-sm" onclick="ajustarCantidad('${p.ID_Producto}', 1.0)">1 kg</button>
                            <button class="btn-sm" onclick="ajustarCantidad('${p.ID_Producto}', 2.0)">2 kg</button>
                        </div>
                        <div class="cantidad-control">
                            <button onclick="cambiarValor('${p.ID_Producto}', -0.1)">-</button>
                            <input type="number" id="cant-${p.ID_Producto}" value="1.0" step="0.1" readonly>
                            <span style="font-size:0.9rem">${unidadTexto}</span>
                            <button onclick="cambiarValor('${p.ID_Producto}', 0.1)">+</button>
                        </div>
                    `;
                } else {
                    // BOTONES PARA UNIDAD (Simples)
                    controlesHTML = `
                        <div class="cantidad-control">
                            <button onclick="cambiarValor('${p.ID_Producto}', -1)">-</button>
                            <input type="number" id="cant-${p.ID_Producto}" value="1" readonly>
                            <span style="font-size:0.9rem">${unidadTexto}</span>
                            <button onclick="cambiarValor('${p.ID_Producto}', 1)">+</button>
                        </div>
                    `;
                }

                // MOSTRAR TARJETA
                const card = document.createElement('div');
                card.className = 'card';
                
                // Texto de oferta si existe
                let ofertaInfo = '';
                if(p.Precio_Oferta && p.Minimo_Oferta) {
                    ofertaInfo = `<div style="font-size:0.8rem; color:green; margin-top:5px;">
                        üî• Oferta: $${p.Precio_Oferta} llevando +${p.Minimo_Oferta} ${unidadTexto}
                    </div>`;
                }

                card.innerHTML = `
                    <img src="${p.Imagen_URL || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300?text=Sin+Foto'">
                    <div class="card-body">
                        <div class="card-title">${p.Nombre}</div>
                        <div class="price-tag">$${p.Precio_Regular} <span style="font-size:0.6em; color:#666">/${unidadTexto}</span></div>
                        ${ofertaInfo}
                        <hr style="margin: 10px 0; border:0; border-top:1px solid #eee;">
                        ${controlesHTML}
                        <button class="btn-add" onclick="agregarAlCarritoComplejo('${p.ID_Producto}')">Agregar +</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- 2. L√ìGICA DE CANTIDADES Y OFERTAS ---
        function cambiarValor(id, delta) {
            const input = document.getElementById(`cant-${id}`);
            let val = parseFloat(input.value) + delta;
            if(val < 0.1) val = 0.1; 
            input.value = Math.round(val * 10) / 10;
        }

        function ajustarCantidad(id, valorFijo) {
            document.getElementById(`cant-${id}`).value = valorFijo;
        }

        function agregarAlCarritoComplejo(id) {
            const producto = productosGlobal.find(p => p.ID_Producto == id);
            const cantidadInput = parseFloat(document.getElementById(`cant-${id}`).value);
            
            // L√≥gica de Oferta: Verificamos precio
            let precioFinal = producto.Precio_Regular;
            
            if (producto.Precio_Oferta && producto.Minimo_Oferta && cantidadInput >= producto.Minimo_Oferta) {
                precioFinal = producto.Precio_Oferta;
            }

            const existente = carrito.find(item => item.id == id);
            if(existente) {
                existente.cantidad += cantidadInput;
                // Re-verificamos la oferta con la nueva cantidad TOTAL acumulada
                if (producto.Precio_Oferta && producto.Minimo_Oferta && existente.cantidad >= producto.Minimo_Oferta) {
                    existente.precio = producto.Precio_Oferta; // Aplicamos el precio de oferta a TODO
                }
            } else {
                carrito.push({
                    id: id,
                    nombre: producto.Nombre,
                    precio: precioFinal,
                    cantidad: cantidadInput,
                    unidad: producto.Unidad
                });
            }
            
            actualizarCarritoUI();
            alert(`¬°Agregamos ${cantidadInput} ${producto.Unidad} de ${producto.Nombre}!`);
        }

        // --- 3. FUNCIONES GENERALES (Carrito, Contenido, Rastreo) ---
        function cargarContenido() {
            fetch(API_URL + '?action=getContenido').then(r => r.json()).then(items => {
                const div = document.getElementById('ofertas-container');
                div.innerHTML = '';
                items.forEach(item => {
                    const el = document.createElement('div'); el.className='card';
                    let media = item.Imagen_URL ? `<img src="${item.Imagen_URL}">` : '';
                    if(item.Video_URL && item.Video_URL.includes('youtube')) {
                        let vidId = item.Video_URL.split('v=')[1]?.split('&')[0];
                        media = `<div class="video-container"><iframe src="https://www.youtube.com/embed/${vidId}"></iframe></div>`;
                    }
                    el.innerHTML = `${media}<div class="card-body"><b>${item.Titulo}</b><p>${item.Descripcion}</p></div>`;
                    div.appendChild(el);
                });
            });
