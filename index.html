<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Vergel | Mercado Fresco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .font-logo { font-family: 'Pacifico', cursive; }
        .bg-naranja { background-color: #FF8C00; }
        .text-naranja { color: #FF8C00; }
        .bg-verde { background-color: #9ACD32; } /* Verde Lima/Amarillento */
        .loader { border-top-color: #FF8C00; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 flex flex-col h-screen overflow-hidden">

    <header class="bg-naranja text-white p-3 shadow-lg flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="lg:hidden text-2xl">‚ò∞</button>
            <h1 class="font-logo text-2xl md:text-3xl tracking-wide">El Vergel</h1>
        </div>
        <button onclick="toggleCart()" class="relative bg-white text-naranja px-4 py-2 rounded-full font-bold shadow-md hover:bg-gray-100 transition">
            üõí <span id="cart-count">0</span>
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        
        <aside id="sidebar" class="absolute lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 w-64 bg-white shadow-xl transition-transform duration-300 z-40 flex flex-col">
            <div class="p-6">
                <h2 class="font-bold text-gray-400 uppercase text-xs mb-4 tracking-wider">Pasillos</h2>
                <nav class="space-y-2">
                    <button onclick="filtrar('Todo')" class="w-full text-left px-4 py-2 rounded-lg bg-naranja text-white font-bold shadow-sm">üè† Todo</button>
                    <button onclick="filtrar('Frutas')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-50 text-gray-600 transition">üçé Frutas</button>
                    <button onclick="filtrar('Verduras')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-gray-50 text-gray-600 transition">ü•¶ Verduras</button>
                    <button onclick="filtrar('Ofertas')" class="w-full text-left px-4 py-2 rounded-lg hover:bg-red-50 text-red-500 font-bold transition">üî• Ofertas</button>
                </nav>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-4 md:p-6 bg-gray-50 w-full relative">
            
            <div id="loader" class="flex justify-center items-center h-64">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
            </div>

            <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 hidden">
                </div>

        </main>
    </div>

    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex justify-end">
        <div class="bg-white w-full max-w-md h-full shadow-2xl flex flex-col transform transition-transform duration-300 translate-x-full" id="cart-panel">
            <div class="p-4 bg-naranja text-white flex justify-between items-center shadow-md">
                <h2 class="text-xl font-bold">Mi Canasta</h2>
                <button onclick="toggleCart()" class="text-2xl">&times;</button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4">
                <p class="text-center text-gray-500 mt-10">Tu carrito est√° vac√≠o ü•ï</p>
            </div>

            <div class="p-6 border-t bg-gray-50">
                <div class="flex justify-between text-xl font-bold mb-4 text-gray-800">
                    <span>Total:</span>
                    <span id="cart-total">$0</span>
                </div>
                <input type="text" id="cliente-nombre" placeholder="Tu Nombre" class="w-full mb-2 p-2 border rounded">
                <input type="tel" id="cliente-tel" placeholder="Tu WhatsApp" class="w-full mb-4 p-2 border rounded">
                
                <button onclick="enviarPedido()" id="btn-pedir" class="w-full bg-verde text-white py-3 rounded-xl font-bold hover:bg-opacity-90 transition shadow-lg">
                    Confirmar Pedido por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN
        const API_URL = "PEGAR_AQUI_TU_URL_DE_APPS_SCRIPT"; 

        let productos = [];
        let carrito = [];

        // 1. INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', async () => {
            await cargarProductos();
        });

        async function cargarProductos() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                productos = data; // Guardamos en memoria
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('product-grid').classList.remove('hidden');
                renderizarProductos(productos);
            } catch (error) {
                console.error("Error cargando:", error);
                document.getElementById('loader').innerHTML = "<p class='text-red-500'>Error de conexi√≥n</p>";
            }
        }

        // 2. RENDERIZADO DE TARJETAS (L√≥gica KG vs Unidad)
        function renderizarProductos(lista) {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = lista.map(p => {
                const esKg = p.tipo_venta === 'kg';
                const tieneOferta = p.precio_oferta < p.precio_base;
                
                return `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-all duration-300">
                    <div class="relative h-48">
                        <img src="${p.imagen}" class="w-full h-full object-cover">
                        ${tieneOferta ? `<span class="absolute top-2 right-2 bg-verde text-white text-xs px-2 py-1 rounded-full font-bold shadow-sm">OFERTA +${p.cantidad_min_oferta}${p.tipo_venta}</span>` : ''}
                    </div>
                    
                    <div class="p-4">
                        <h3 class="font-bold text-gray-800 text-lg mb-1 leading-tight">${p.nombre}</h3>
                        <div class="flex justify-between items-baseline mb-3">
                            <span class="text-naranja font-bold text-xl">$${p.precio_base}</span>
                            <span class="text-gray-400 text-sm">/${p.tipo_venta}</span>
                        </div>

                        <div id="controls-${p.id}" class="hidden space-y-3 pt-3 border-t border-dashed border-gray-200 bg-gray-50 -mx-4 px-4 pb-4 mt-2">
                            ${esKg ? generarControlesKg(p) : generarControlesUnidad(p)}
                            <button onclick="agregarAlCarrito('${p.id}')" class="w-full bg-black text-white py-2 rounded-lg text-sm font-bold hover:bg-gray-800">Confirmar</button>
                        </div>

                        <button id="btn-trigger-${p.id}" onclick="toggleControls('${p.id}')" class="w-full bg-naranja text-white py-2 rounded-xl font-bold text-sm shadow-md hover:opacity-90 transition transform active:scale-95">
                            Agregar
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function generarControlesKg(p) {
            return `
            <div class="flex gap-2">
                <button onclick="setCantidad('${p.id}', 0.5)" class="flex-1 bg-white border border-gray-300 rounded text-xs py-1 hover:border-naranja hover:text-naranja">1/2 kg</button>
                <button onclick="setCantidad('${p.id}', 1)" class="flex-1 bg-white border border-gray-300 rounded text-xs py-1 hover:border-naranja hover:text-naranja">1 kg</button>
            </div>
            <div class="flex items-center justify-between bg-white rounded border px-2 py-1">
                <button onclick="ajustarCantidad('${p.id}', -0.1)" class="text-xl text-gray-500 font-bold px-2">-</button>
                <span id="cant-${p.id}" class="font-bold text-sm">1.0</span> <span class="text-xs text-gray-400">kg</span>
                <button onclick="ajustarCantidad('${p.id}', 0.1)" class="text-xl text-naranja font-bold px-2">+</button>
            </div>`;
        }

        function generarControlesUnidad(p) {
            return `
            <div class="flex items-center justify-center gap-4 bg-white rounded border p-1">
                <button onclick="ajustarCantidad('${p.id}', -1)" class="text-xl text-gray-500 font-bold px-3">-</button>
                <span id="cant-${p.id}" class="font-bold text-lg">1</span>
                <button onclick="ajustarCantidad('${p.id}', 1)" class="text-xl text-naranja font-bold px-3">+</button>
            </div>`;
        }

        // 3. INTERACCI√ìN UI
        let cantidadesTemp = {}; // Almacena cantidad seleccionada temporalmente

        function toggleControls(id) {
            const controls = document.getElementById(`controls-${id}`);
            const btn = document.getElementById(`btn-trigger-${id}`);
            const isHidden = controls.classList.contains('hidden');
            
            // Resetear UI
            document.querySelectorAll('[id^="controls-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="btn-trigger-"]').forEach(el => el.style.display = 'block');

            if (isHidden) {
                controls.classList.remove('hidden');
                btn.style.display = 'none';
                cantidadesTemp[id] = 1; // Default
            }
        }

        function ajustarCantidad(id, delta) {
            let actual = cantidadesTemp[id] || 1;
            let prod = productos.find(p => p.id == id);
            
            actual += delta;
            
            // Validaciones
            if (prod.tipo_venta === 'kg') actual = Math.max(0.1, actual); // Minimo 100gr
            else actual = Math.max(1, actual);

            cantidadesTemp[id] = parseFloat(actual.toFixed(1));
            document.getElementById(`cant-${id}`).innerText = cantidadesTemp[id];
        }

        function setCantidad(id, valor) {
            cantidadesTemp[id] = valor;
            document.getElementById(`cant-${id}`).innerText = valor;
        }

        // 4. L√ìGICA DE PRECIOS Y CARRITO
        function agregarAlCarrito(id) {
            const prod = productos.find(p => p.id == id);
            const cantidad = cantidadesTemp[id] || 1;
            
            // L√≥gica de Precio Escalonado
            let precioFinal = prod.precio_base;
            if (prod.precio_oferta && cantidad >= prod.cantidad_min_oferta) {
                precioFinal = prod.precio_oferta;
            }

            const itemExistente = carrito.find(item => item.id == id);
            
            if (itemExistente) {
                itemExistente.cantidad += cantidad;
                // Recalcular precio por si ahora supera el m√≠nimo de oferta
                if (prod.precio_oferta && itemExistente.cantidad >= prod.cantidad_min_oferta) {
                    itemExistente.precio = prod.precio_oferta;
                }
            } else {
                carrito.push({
                    id: prod.id,
                    nombre: prod.nombre,
                    cantidad: cantidad,
                    precio: precioFinal,
                    tipo: prod.tipo_venta
                });
            }

            actualizarCarritoUI();
            toggleControls(id); // Cerrar panel
        }

        function actualizarCarritoUI() {
            const count = document.getElementById('cart-count');
            const totalDisplay = document.getElementById('cart-total');
            const itemsContainer = document.getElementById('cart-items');
            
            // Totalizar
            let total = 0;
            let itemsCount = 0;
            
            itemsContainer.innerHTML = '';
            
            carrito.forEach((item, index) => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                itemsCount += 1;

                itemsContainer.innerHTML += `
                    <div class="flex justify-between items-center border-b pb-2">
                        <div>
                            <p class="font-bold text-sm">${item.nombre}</p>
                            <p class="text-xs text-gray-500">${item.cantidad} ${item.tipo} x $${item.precio}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold">$${Math.round(subtotal)}</span>
                            <button onclick="eliminarItem(${index})" class="text-red-500 text-xs">üóë</button>
                        </div>
                    </div>
                `;
            });

            count.innerText = itemsCount;
            cartTotal = Math.round(total);
            totalDisplay.innerText = `$${cartTotal}`;
        }

        function eliminarItem(index) {
            carrito.splice(index, 1);
            actualizarCarritoUI();
        }

        // 5. ENV√çO DE PEDIDO
        async function enviarPedido() {
            const nombre = document.getElementById('cliente-nombre').value;
            const tel = document.getElementById('cliente-tel').value;

            if (!nombre || !tel || carrito.length === 0) {
                alert("Por favor completa tus datos y agrega productos.");
                return;
            }

            const btn = document.getElementById('btn-pedir');
            btn.innerText = "Enviando...";
            btn.disabled = true;

            const pedido = {
                cliente: { nombre, telefono: tel },
                carrito: carrito,
                total: cartTotal
            };

            // Enviar a Apps Script (POST)
            // Usamos 'no-cors' para evitar errores simples, aunque no leamos respuesta directa
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(pedido)
                });
                
                alert(`¬°Pedido Enviado! Gracias ${nombre}.`);
                carrito = [];
                actualizarCarritoUI();
                toggleCart();
            } catch (e) {
                alert("Hubo un error al enviar, intenta nuevamente.");
                console.error(e);
            } finally {
                btn.innerText = "Confirmar Pedido";
                btn.disabled = false;
            }
        }

        // UI Helpers
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }
        function toggleCart() {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10);
            } else {
                panel.classList.add('translate-x-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }
    </script>
</body>
</html>
