<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Vergel | Pedidos Online</title>
    <style>
        :root { --primary: #4CAF50; --dark: #333; --light: #f9f9f9; --alert: #ff9800; }
        body { font-family: sans-serif; margin: 0; background: var(--light); color: var(--dark); padding-bottom: 60px; }
        
        header { background: white; padding: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: bold; font-size: 1.5rem; color: var(--primary); text-decoration: none; }
        
        /* Banner de Tienda Cerrada */
        #store-status-banner { background: var(--alert); color: white; text-align: center; padding: 10px; display: none; font-weight: bold; }

        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        h2 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-top: 40px; }

        /* Grilla de Productos */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding-bottom: 15px; }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; }
        .price { font-size: 1.2rem; color: var(--primary); font-weight: bold; }
        .offer-text { color: green; font-size: 0.9rem; margin-bottom: 10px; }

        /* Controles de Cantidad */
        .controls { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; background: #f0f0f0; border-radius: 5px; padding: 5px; }
        .controls button { background: #ddd; border: none; width: 30px; height: 30px; border-radius: 50%; font-weight: bold; cursor: pointer; }
        .controls input { width: 60px; text-align: center; border: none; background: transparent; font-weight: bold; font-size: 1.1rem; }
        .quick-btn { font-size: 0.8rem; padding: 5px 10px; background: var(--primary); color: white; border: none; border-radius: 15px; cursor: pointer; margin-top: 5px; }

        /* Modal Carrito */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 500px; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
        .btn-checkout { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; font-size: 1.1rem; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        .btn-checkout:disabled { background: #ccc; }

        /* Links de Contacto */
        .contact-links { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-link { padding: 10px 20px; text-decoration: none; color: white; border-radius: 5px; font-weight: bold; }
        .whatsapp { background: #25D366; } .instagram { background: #E1306C; } .forms { background: #333; }

        /* Rastreo */
        .tracking-box { background: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>

    <div id="store-status-banner">üö´ TIENDA CERRADA: No se aceptan pedidos en este momento.</div>
    <header>
        <a href="#" class="logo">El Vergel üçé</a>
        <div onclick="abrirCarrito()" style="cursor: pointer;">
            üõí <span id="cart-count">0</span>
        </div>
    </header>

    <div class="container">
        
        <div class="tracking-box">
            <h3>üì¶ Rastrear Pedido</h3>
            <input type="text" id="track-id" placeholder="Ingresa tu c√≥digo (ej: 05102025-1234)" style="padding: 8px; width: 60%;">
            <button onclick="rastrearPedido()" class="quick-btn">Buscar</button>
            <div id="track-result" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <section id="contenido-section">
            <h2>üî• Tips y Recetas</h2>
            <div id="contenido-grid" class="grid">Cargando...</div>
        </section>

        <section id="productos-section">
            <h2>ü•¨ Productos Frescos</h2>
            <div id="productos-grid" class="grid">Cargando productos...</div>
        </section>

        <section id="contacto" style="margin-top: 50px; text-align: center;">
            <h3>Contacto y Opiniones</h3>
            <p>üìç Calle Falsa 123 | üìß email@elvergel.com</p>
            <div class="contact-links" style="justify-content: center;">
                <a href="#" class="btn-link whatsapp">WhatsApp</a>
                <a href="#" class="btn-link instagram">Instagram</a>
                <a href="LINK_A_TU_FORM_SUGERENCIAS" class="btn-link forms">Buz√≥n Sugerencias</a>
                <a href="LINK_A_TU_FORM_RECLAMOS" class="btn-link forms" style="background:red;">Libro Reclamos</a>
            </div>
            <p>&copy; 2026 El Vergel</p>
        </section>
    </div>

    <div id="modal-carrito" class="modal">
        <div class="modal-content">
            <h3>Tu Canasta</h3>
            <div id="carrito-items"></div>
            <p style="text-align: right; font-size: 1.2rem;">Total: $<span id="carrito-total">0</span></p>
            
            <hr>
            <h4>Datos de Env√≠o</h4>
            <input type="text" id="cliente-nombre" placeholder="Tu Nombre" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <input type="tel" id="cliente-wpp" placeholder="Tu WhatsApp" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            
            <label>Hora de Retiro (Min 30 min):</label>
            <input type="time" id="cliente-hora" style="width: 100%; padding: 10px; margin-bottom: 10px;">

            <button id="btn-enviar" class="btn-checkout" onclick="enviarPedido()">‚úÖ Confirmar Pedido</button>
            <button onclick="document.getElementById('modal-carrito').style.display='none'" style="width: 100%; background: none; border: none; margin-top: 10px; color: #666; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è PEGA AQU√ç TU URL GENERADA
        const API_URL = 'AQUI_TU_URL_DEL_SCRIPT'; 

        let productos = [];
        let carrito = [];
        let tiendaAbierta = true;

        // INICIALIZACI√ìN
        window.onload = () => {
            verificarEstadoTienda();
            cargarProductos();
            cargarContenido();
        };

        function verificarEstadoTienda() {
            fetch(API_URL + '?action=getEstadoTienda')
            .then(r => r.json())
            .then(data => {
                if(data.estado === "CERRADO") {
                    tiendaAbierta = false;
                    document.getElementById('store-status-banner').style.display = 'block';
                    document.getElementById('store-status-banner').innerText = "üö´ " + (data.mensaje || "Tienda Cerrada");
                    document.getElementById('btn-enviar').disabled = true;
                    document.getElementById('btn-enviar').innerText = "Tienda Cerrada";
                }
            });
        }

        // CARGA DE DATOS
        function cargarProductos() {
            fetch(API_URL + '?action=getProductos').then(r => r.json()).then(data => {
                productos = data;
                renderProductos(data);
            });
        }
        
        function cargarContenido() {
             fetch(API_URL + '?action=getContenido').then(r => r.json()).then(data => {
                const div = document.getElementById('contenido-grid');
                div.innerHTML = data.map(c => `
                    <div class="card">
                        ${c.Video_URL ? '<iframe src="'+c.Video_URL+'" style="width:100%; border:none;"></iframe>' : ''}
                        <div class="card-body"><strong>${c.Titulo}</strong><p>${c.Descripcion}</p></div>
                    </div>
                `).join('');
            });
        }

        // RENDERIZADO INTELIGENTE (KG vs UN)
        function renderProductos(lista) {
            const container = document.getElementById('productos-grid');
            container.innerHTML = lista.map(p => {
                // Si no est√° disponible, no mostrar
                if(p.Disponible === "FALSE" || p.Disponible === false) return '';

                const esKg = p.Unidad === 'kg';
                const step = esKg ? 0.1 : 1;
                const min = esKg ? 0.1 : 1;
                
                // Botones extra para KG
                const botonesRapidos = esKg ? `
                    <div style="display:flex; gap:5px; justify-content:center;">
                        <button class="quick-btn" onclick="setCant('${p.ID_Producto}', 0.5)">¬Ω kg</button>
                        <button class="quick-btn" onclick="setCant('${p.ID_Producto}', 1.0)">1 kg</button>
                    </div>` : '';

                // Texto de oferta
                const ofertaTxt = (p.Precio_Oferta && p.Minimo_Oferta) ? 
                    `<div class="offer-text">üî• Oferta: $${p.Precio_Oferta} llevando +${p.Minimo_Oferta}${p.Unidad}</div>` : '';

                return `
                <div class="card">
                    <img src="${p.Imagen || 'https://via.placeholder.com/300'}" alt="${p.Nombre}">
                    <div class="card-body">
                        <h3>${p.Nombre}</h3>
                        <div class="price">$${p.Precio_Regular}/${p.Unidad}</div>
                        ${ofertaTxt}
                        <hr>
                        ${botonesRapidos}
                        <div class="controls">
                            <button onclick="cambiarCant('${p.ID_Producto}', -${step})">-</button>
                            <input type="number" id="cant-${p.ID_Producto}" value="${min}" step="${step}" min="${min}" readonly>
                            <span>${p.Unidad}</span>
                            <button onclick="cambiarCant('${p.ID_Producto}', ${step})">+</button>
                        </div>
                        <button class="btn-checkout" style="margin-top:10px; padding:8px;" onclick="agregar('${p.ID_Producto}')">Agregar</button>
                    </div>
                </div>`;
            }).join('');
        }

        // L√ìGICA DE CARRITO Y CANTIDADES
        function cambiarCant(id, delta) {
            const el = document.getElementById('cant-'+id);
            let val = parseFloat(el.value) + delta;
            if(val < 0.1) val = 0.1;
            el.value = Math.round(val * 10) / 10;
        }
        function setCant(id, val) { document.getElementById('cant-'+id).value = val; }

        function agregar(id) {
            if(!tiendaAbierta) return alert("La tienda est√° cerrada.");
            
            const prod = productos.find(p => p.ID_Producto == id);
            const cant = parseFloat(document.getElementById('cant-'+id).value);
            
            // L√ìGICA DE PRECIO (Oferta vs Regular)
            let precioFinal = prod.Precio_Regular;
            if(prod.Precio_Oferta && cant >= prod.Minimo_Oferta) {
                precioFinal = prod.Precio_Oferta;
            }

            // Buscar si ya existe y actualizar
            const index = carrito.findIndex(i => i.id == id);
            if(index > -1) {
                carrito[index].cantidad += cant;
                // Recalcular precio oferta si sumando supera el m√≠nimo
                if(prod.Precio_Oferta && carrito[index].cantidad >= prod.Minimo_Oferta) {
                    carrito[index].precio = prod.Precio_Oferta;
                }
            } else {
                carrito.push({
                    id: id, nombre: prod.Nombre, precio: precioFinal, cantidad: cant, unidad: prod.Unidad
                });
            }
            actualizarUI();
            alert("Agregado al carrito");
        }

        function actualizarUI() {
            document.getElementById('cart-count').innerText = carrito.length;
            const itemsDiv = document.getElementById('carrito-items');
            let total = 0;
            itemsDiv.innerHTML = carrito.map((item, i) => {
                const subtotal = item.precio * item.cantidad;
                total += subtotal;
                return `<div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid #eee;">
                    <span>${item.nombre} (${item.cantidad} ${item.unidad})</span>
                    <span>$${Math.round(subtotal)} <button onclick="eliminar(${i})" style="color:red;border:none;">x</button></span>
                </div>`;
            }).join('');
            document.getElementById('carrito-total').innerText = Math.round(total);
        }

        function eliminar(i) { carrito.splice(i,1); actualizarUI(); }
        function abrirCarrito() { document.getElementById('modal-carrito').style.display='flex'; }

        // ENV√çO DE PEDIDO
        function enviarPedido() {
            const nombre = document.getElementById('cliente-nombre').value;
            const wpp = document.getElementById('cliente-wpp').value;
            const hora = document.getElementById('cliente-hora').value;

            // Validar Hora (m√≠nimo 30 min)
            if(!hora) return alert("Elige hora de retiro");
            // Aqu√≠ podr√≠as agregar validaci√≥n compleja de hora, por ahora es simple

            if(!nombre || !wpp || carrito.length === 0) return alert("Completa los datos");

            const btn = document.getElementById('btn-enviar');
            btn.innerText = "Enviando..."; btn.disabled = true;

            const pedido = {
                nombre: nombre, whatsapp: wpp, horaRetiro: hora,
                total: document.getElementById('carrito-total').innerText,
                carrito: carrito.map(c => ({
                    nombre: c.nombre, cantidad: c.cantidad + " " + c.unidad, subtotal: c.cantidad * c.precio
                }))
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(pedido)
            })
            .then(r => r.json())
            .then(res => {
                if(res.status === 'success') {
                    alert("¬°Pedido Enviado! Tu c√≥digo es: " + res.idPedido);
                    carrito = []; actualizarUI();
                    document.getElementById('modal-carrito').style.display='none';
                } else {
                    alert("Error: " + res.message);
                }
                btn.innerText = "Confirmar Pedido"; btn.disabled = false;
            });
        }

        // RASTREO
        function rastrearPedido() {
            const id = document.getElementById('track-id').value;
            if(!id) return;
            document.getElementById('track-result').innerText = "Buscando...";
            fetch(API_URL + '?action=getPedido&id=' + id)
            .then(r => r.json())
            .then(data => {
                if(data.encontrado) {
                    document.getElementById('track-result').innerHTML = 
                        `Estado: <span style="color:blue">${data.estado}</span> | Total: $${data.total}`;
                } else {
                    document.getElementById('track-result').innerText = "Pedido no encontrado.";
                }
            });
        }
    </script>
</body>
</html>
